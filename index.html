<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3 Taxi Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        svg { font: 10px sans-serif; }
        .bar { fill: steelblue; cursor: pointer; }
        .bar:hover { fill: orange; }
        .tooltip { position: absolute; text-align: center; padding: 5px; background: lightgrey; border: 1px solid #ccc; pointer-events: none; }
    </style>
</head>
<body>
<h2>Taxi Trip Visualizations</h2>
<svg id="map" width="800" height="400"></svg>
<svg id="barChart" width="800" height="300"></svg>
<svg id="pieChart" width="400" height="400"></svg>

<script>
const mapSvg = d3.select("#map"),
      barSvg = d3.select("#barChart"),
      pieSvg = d3.select("#pieChart"),
      width = 800, height = 400;

let taxiData = [];
fetch('trips.json')
  .then(res => res.json())
  .then(data => {
    taxiData = data.features;
    drawMap(taxiData);
    drawBarChart(taxiData);
  });

function drawMap(data) {
    const projection = d3.geoMercator()
        .center([-8.61, 41.15])
        .scale(70000)
        .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    mapSvg.selectAll("path")
        .data(data)
        .join("path")
        .attr("d", d => path({ type: "LineString", coordinates: d.geometry.coordinates }))
        .attr("fill", "none")
        .attr("stroke", "green")
        .attr("stroke-width", 1.5);
}

function drawBarChart(data) {
    const taxiCounts = d3.rollups(data, v => v.length, d => d.properties.taxiid);

    const x = d3.scaleBand()
        .domain(taxiCounts.map(d => d[0]))
        .range([0, width])
        .padding(0.1);

    const y = d3.scaleLinear()
        .domain([0, d3.max(taxiCounts, d => d[1])])
        .range([300, 0]);

    barSvg.selectAll(".bar")
        .data(taxiCounts)
        .join("rect")
        .attr("class", "bar")
        .attr("x", d => x(d[0]))
        .attr("y", d => y(d[1]))
        .attr("width", x.bandwidth())
        .attr("height", d => 300 - y(d[1]))
        .on("click", (event, d) => drawPieChart(d[0]));

    barSvg.append("g")
        .attr("transform", "translate(0,300)")
        .call(d3.axisBottom(x).tickFormat(d => d).tickSize(0).tickPadding(10))
        .selectAll("text")
        .attr("transform", "rotate(45)")
        .style("text-anchor", "start");

    barSvg.append("g")
        .call(d3.axisLeft(y));
}

function drawPieChart(taxiid) {
    const tripStats = taxiData.filter(d => d.properties.taxiid === taxiid);
    const pieData = [
        { label: "Short", value: tripStats.filter(d => d.properties.distance < 2000).length },
        { label: "Medium", value: tripStats.filter(d => d.properties.distance >= 2000 && d.properties.distance < 5000).length },
        { label: "Long", value: tripStats.filter(d => d.properties.distance >= 5000).length },
    ];

    const radius = 200;
    const pie = d3.pie().value(d => d.value);
    const arc = d3.arc().innerRadius(0).outerRadius(radius - 20);

    pieSvg.selectAll("*").remove();

    const g = pieSvg.append("g")
        .attr("transform", `translate(${radius},${radius})`);

    const arcs = g.selectAll(".arc")
        .data(pie(pieData))
        .enter().append("g")
        .attr("class", "arc");

    arcs.append("path")
        .attr("d", arc)
        .attr("fill", (d, i) => d3.schemeSet2[i]);

    arcs.append("text")
        .attr("transform", d => `translate(${arc.centroid(d)})`)
        .attr("dy", "0.35em")
        .attr("text-anchor", "middle")
        .text(d => `${d.data.label} (${d.data.value})`);
}
</script>
</body>
</html>